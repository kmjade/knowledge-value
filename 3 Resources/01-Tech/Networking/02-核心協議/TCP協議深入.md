---
title: TCP协议深入
aliases:
  - Transmission Control Protocol
  - 三次握手
  - 四次挥手
para: resource
tags:
  - #para/resource/tech
  - #topic/networking
  - #protocol/tcp
  - #layer/transport
  - #type/concept
  - #zettel/type/permanent
created: 2026-01-21
---

> [!summary] TCP协议概述
> TCP (Transmission Control Protocol) 是傳輸层协议，提供可靠的、面向連接的字节流傳輸服务。

---

## 🎯 TCP特點

| 特點 | 說明 |
|------|------|
| ✅ **面向連接** | 需要三次握手建立連接 |
| ✅ **可靠傳輸** | 確認应答、重传機制 |
| ✅ **有序傳輸** | 使用序列号保证顺序 |
| ✅ **流量控制** | 滑动視窗機制 |
| ✅ **拥塞控制** | 慢啟動、拥塞避免 |
| ⚠️ **面向字节流** | 無訊息边界 |

---

## 🔄 三次握手

### 過程图

```
客户端                           伺服器
  │                               │
  │─── SYN=1, seq=x ─────────────→│ (SYN_SENT)
  │                               │
  │←── SYN=1, ACK=1, seq=y, ack=x+1 ──│ (SYN_RCVD)
  │                               │
  │─── ACK=1, seq=x+1, ack=y+1 ──→│ (ESTABLISHED)
  │                               │ (ESTABLISHED)
  │     連接建立成功                 │
```

### 詳細步骤

1. **客户端發送SYN**：
   - SYN=1, seq=x（初始序列号）
   - 客户端进入 `SYN_SENT` 狀態

2. **伺服器回覆SYN+ACK**：
   - SYN=1, ACK=1, seq=y, ack=x+1
   - 伺服器进入 `SYN_RCVD` 狀態

3. **客户端發送ACK**：
   - ACK=1, seq=x+1, ack=y+1
   - 双方都进入 `ESTABLISHED` 狀態

### 为什么是三次？

- **一次握手**：無法確認双方都能收发
- **两次握手**：無法確認客户端的接收能力
- **三次握手**：确保双方收发能力都正常

---

## 👋 四次挥手

### 過程图

```
客户端                           伺服器
  │ (ESTABLISHED)                │ (ESTABLISHED)
  │                               │
  │─── FIN=1, seq=u ────────────→│ (FIN_WAIT_1)
  │                               │
  │←── ACK=1, seq=v, ack=u+1 ─────│ (FIN_WAIT_2)
  │                               │ (CLOSE_WAIT)
  │                               │
  │←── FIN=1, seq=w, ack=u+1 ─────│ (LAST_ACK)
  │                               │
  │─── ACK=1, seq=u+1, ack=w+1 ──→│ (TIME_WAIT)
  │                               │ (CLOSED)
  │ 等待2MSL                       │
  │ (CLOSED)                      │
```

### 詳細步骤

1. **客户端發送FIN**：
   - 客户端不再發送數據
   - 进入 `FIN_WAIT_1` 狀態

2. **伺服器回覆ACK**：
   - 確認收到FIN
   - 客户端进入 `FIN_WAIT_2`
   - 伺服器进入 `CLOSE_WAIT`

3. **伺服器發送FIN**：
   - 伺服器數據發送完毕
   - 进入 `LAST_ACK`

4. **客户端回覆ACK**：
   - 进入 `TIME_WAIT`
   - 等待2MSL（Maximum Segment Lifetime）
   - 最终进入 `CLOSED`

### 为什么是四次？

- **三次不够**：伺服器可能还有數據需要發送
- 需要分别確認双方的數據都已傳輸完毕

---

## 🎛️ 滑动視窗

### 概念

滑动視窗是TCP流量控制的核心機制，通過動態调整發送視窗大小来控制發送速率。

```
發送視窗
┌────┬────┬────┬────┬────┬────┬────┬────┐
│已发│已发│未发│未发│未发│未发│未发│未发│
│已确│未确│    │    │    │    │    │    │
└────┴────┴────┴────┴────┴────┴────┴────┘
    ↑    ↑         ↑
  SND.UNA SND.NXT  SND.UNA+WND
```

### 視窗字段

- **視窗大小**：接收缓冲区可用空間
- **接收視窗**：接收方告诉發送方还能发多少數據
- **發送視窗**：發送方实际可發送的數據量

---

## 🚦 拥塞控制

### 四个階段

```
        拥塞視窗
            │
            │    ┌────────┐
            │   /│        │
            │  / │  慢啟動│
            │ /  └────────┘
            │/
            │──────────────────────
            │                    \
            │                     \ ┌───────────┐
            │                      \| 拥塞避免  │
            │                       └───────────┘
            │
            │     ┌───────────┐
            │    /│           │
            │   / │  快重传   │
            │  /  └───────────┘
            │ /
            │/
            └─────────────────────────
              拥塞視窗
```

### 算法

#### 1. 慢啟動
- 初始視窗：1 MSS
- 每次RTT視窗翻倍：cwnd *= 2
- 达到慢啟動阈值（ssthresh）后进入拥塞避免

#### 2. 拥塞避免
- 每次RTT視窗增加1 MSS：cwnd += 1
- 线性增长

#### 3. 快重传
- 收到3个重复ACK
- 立即重传遺失的报文
- cwnd = ssthresh / 2
- ssthresh = cwnd / 2

#### 4. 快恢復
- 进入快恢復狀態
- 不进入慢啟動
- cwnd = ssthresh
- 收到新的ACK后，cwnd += 1 MSS

---

## 📊 TCP头部格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 字段說明

| 字段 | 大小 | 說明 |
|------|------|------|
| 源端口 | 16位 | 發送端口号 |
| 目的端口 | 16位 | 接收端口号 |
| 序列号 | 32位 | 數據字节序号 |
| 確認号 | 32位 | 期望收到的下一个字节序号 |
| 數據偏移 | 4位 | TCP头部长度 |
| URG | 1位 | 紧急指针有效 |
| ACK | 1位 | 確認号有效 |
| PSH | 1位 | 推送數據 |
| RST | 1位 | 重置連接 |
| SYN | 1位 | 同步序号 |
| FIN | 1位 | 結束連接 |
| 視窗 | 16位 | 接收視窗大小 |
| 校验和 | 16位 | 头部和數據的校验 |
| 紧急指针 | 16位 | 紧急數據的偏移量 |

---

## 🆚 TCP vs UDP

| 特性 | TCP | UDP |
|------|-----|-----|
| 連接 | 面向連接 | 無連接 |
| 可靠性 | 可靠 | 不可靠 |
| 顺序 | 有序 | 無序 |
| 流量控制 | 有 | 無 |
| 拥塞控制 | 有 | 無 |
| 速度 | 较慢 | 较快 |
| 开销 | 较大 | 较小 |
| 适用場景 | Web、電子郵件、檔案傳輸 | 視訊、游戏、DNS |

---

## 🛠️ 實踐示例

### 使用tcpdump抓包

```bash
# 抓取TCP包
tcpdump -i eth0 tcp

# 抓取特定端口的TCP包
tcpdump -i eth0 tcp port 80

# 顯示
tcpdump -i eth0 -vvv tcp

# 儲存到檔案
tcpdump -i eth0 -w tcp.pcap tcp
```

# 分析

1. 安裝Wireshark
2. 選擇网卡開始捕获
3. 过滤器：`tcp`
# 查看

---

## 📝 學習檢查清單

- [ ] 能画出TCP三次握手和四次挥手的流程图
- [ ] 理解三次握手为什么需要三次
- [ ] 理解滑动視窗的流量控制機制
- [ ] 了解TCP拥塞控制的四个階段
- [ ] 知道TCP头部的主要字段
- [ ] 能区分TCP和UDP的應用程式場景

---

## 🔗 相關連結

- 🔙 [[02-核心协议|返回核心协议]]
- 📖 [[UDP协议]]
# 分析

---

# 更新
