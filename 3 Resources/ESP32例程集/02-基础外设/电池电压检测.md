---
title: ç”µæ± ç”µå‹æ£€æµ‹
status: active
priority: medium
tags: [esp32/examples, adc, voltage]
aliases: [ç”µå‹æ£€æµ‹, ADCè¯»å–]
created: 2026-02-19
modified: 2026-02-19
source: https://www.yahboom.com/public/upload/upload-html/1706346778/%E7%94%B5%E6%B1%A0%E7%94%B5%E5%8E%8B%E6%A3%80%E6%B5%8B.html
related:
  - [[MicroROSæœºå™¨äººæ§åˆ¶æ¿]]
  - [[ESP32å¼€å‘åŸºç¡€]]
---

# ç”µæ± ç”µå‹æ£€æµ‹

> ä½¿ç”¨microROSæ§åˆ¶æ¿ä¸Šç”µå‹æ£€æµ‹åŠŸèƒ½ï¼Œå­¦ä¹ ESP32è¯»å–ADCæ•°å€¼çš„åŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

- [å®éªŒç›®çš„](#ä¸€å®éªŒç›®çš„)
- [ç¡¬ä»¶è¿æ¥](#äºŒç¡¬ä»¶è¿æ¥)
- [æ ¸å¿ƒä»£ç è§£æ](#ä¸‰æ ¸å¿ƒä»£ç è§£æ)
- [ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶](#å››ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶)
- [å®éªŒæ•ˆæœ](#äº”å®éªŒæ•ˆæœ)

---

## ä¸€ã€å®éªŒç›®çš„

ä½¿ç”¨microROSæ§åˆ¶æ¿ä¸Šç”µå‹æ£€æµ‹åŠŸèƒ½ï¼Œå­¦ä¹ ESP32è¯»å–ADCæ•°å€¼çš„åŠŸèƒ½ã€‚

---

## äºŒã€ç¡¬ä»¶è¿æ¥

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”µæ± ç”µå‹æ£€æµ‹ç”µè·¯å·²ç»é›†æˆåœ¨microROSæ§åˆ¶æ¿ä¸Šï¼Œæ‰€ä»¥ä¸éœ€è¦å¤–æ¥å…¶ä»–è®¾å¤‡ï¼Œåªéœ€è¦æŠŠtype-Cæ•°æ®çº¿è¿æ¥ç”µè„‘ä¸microROSæ§åˆ¶æ¿ä½œä¸ºçƒ§å½•å›ºä»¶åŠŸèƒ½å³å¯ã€‚

![image-20240111113845152](https://www.yahboom.com/public/upload/upload-html/1706346778/image-20240111113845152.png)

---

## ä¸‰ã€æ ¸å¿ƒä»£ç è§£æ

ç¨‹åºæºç å¯¹åº”çš„è™šæ‹Ÿæœºè·¯å¾„ä¸ºï¼š

```
~/esp/Samples/esp32_samples/voltage
```

### åˆå§‹åŒ–ç”µæ± ç”µå‹æ£€æµ‹ADCé€šé“

ç”µå‹æ£€æµ‹è¿æ¥çš„ç¡¬ä»¶GPIOä¸ºGPIO3ï¼Œå¯¹åº”ADCé€šé“ä¸ºADC1é€šé“2ã€‚

```c
static void Battery_Adc_Init(void)
{
    adc_oneshot_unit_init_cfg_t init_config1 = {
        .unit_id = ADC_UNIT_1,
    };
    ESP_ERROR_CHECK(adc_oneshot_new_unit(&init_config1, &battery_handle));

    adc_oneshot_chan_cfg_t config = {
        .bitwidth = ADC_BITWIDTH_DEFAULT,
        .atten = ADC_ATTEN_BATTERY,
    };
    ESP_ERROR_CHECK(adc_oneshot_config_channel(battery_handle, ADC_CHANNEL_BATTERY, &config));
    Battery_Adc_Calibration_Init(ADC_UNIT_1, ADC_CHANNEL_BATTERY, ADC_ATTEN_BATTERY, &battery_cali_handle);
}
```

### ADCè½¬åŒ–ç”µå‹åˆå§‹åŒ–

ç”±äºADCè¯»å–å‡ºæ¥çš„æ•°å€¼éœ€è¦ç»è¿‡è½¬åŒ–æ‰å¯ä»¥å¾—åˆ°GPIOçš„ç”µå‹å€¼ï¼Œæ‰€ä»¥éœ€è¦åˆå§‹åŒ–ä¸€ä¸‹ADCè½¬åŒ–ç”µå‹çš„åŠŸèƒ½ã€‚

```c
static bool Battery_Adc_Calibration_Init(adc_unit_t unit, adc_channel_t channel, adc_atten_t atten, adc_cali_handle_t *out_handle)
{
    adc_cali_handle_t handle = NULL;
    esp_err_t ret = ESP_FAIL;
    bool calibrated = false;

    if (!calibrated)
    {
        ESP_LOGI(TAG, "calibration scheme version is %s", "Curve Fitting");

        adc_cali_curve_fitting_config_t cali_config = {
            .unit_id = unit,
            .chan = channel,
            .atten = atten,
            .bitwidth = ADC_BITWIDTH_DEFAULT,
        };

        ret = adc_cali_create_scheme_curve_fitting(&cali_config, &handle);

        if (ret == ESP_OK)
        {
            calibrated = true;
        }
    }

    *out_handle = handle;

    if (ret == ESP_OK)
    {
        ESP_LOGI(TAG, "Calibration Success");
    }
    else
    {
        ESP_LOGE(TAG, "Invalid arg or no memory");
    }

    return calibrated;
}
```

### ç”µæ± ç”µå‹æ£€æµ‹ä»»åŠ¡

æ ¹æ®ADC1é€šé“2è¯»å–åˆ°çš„ADCå€¼è½¬åŒ–æˆGPIOç”µå‹å€¼ã€‚

```c
static void Battery_Task(void *arg)
{
    ESP_LOGI(TAG, "Start Battery_Task with core:%d", xPortGetCoreID());

    while (1)
    {
        ESP_ERROR_CHECK(adc_oneshot_read(battery_handle, ADC_CHANNEL_BATTERY, &adc_raw));
        ESP_ERROR_CHECK(adc_cali_raw_to_voltage(battery_cali_handle, adc_raw, &cali_voltage));
        Battery_Update_Voltage(cali_voltage);

        vTaskDelay(pdMS_TO_TICKS(100));
    }

    // ç»“æŸä»»åŠ¡å‰æ³¨é”€ADC
    ESP_ERROR_CHECK(adc_oneshot_del_unit(battery_handle));
    Battery_Adc_Calibration_Init_Deinit(battery_cali_handle);
    vTaskDelete(NULL);
}
```

### è®¡ç®—ç”µæ± ç«¯ç”µå‹

```c
static void Battery_Update_Voltage(int gpio_voltage_mV)
{
    // battery_voltage = gpio_voltage*(10+3.3)/3.3;
    battery_voltage = gpio_voltage_mV / 1000.0 * 4.03;
}

float Battery_Get_Voltage(void)
{
    return battery_voltage;
}
```

åœ¨app_mainé‡Œè°ƒç”¨Battery_Initå‡½æ•°åˆå§‹åŒ–ç”µæ± ç”µå‹ADCæ¥å£ï¼Œç„¶ååœ¨å¾ªç¯ä¸­æ¯500æ¯«ç§’æ‰“å°ä¸€æ¬¡å½“å‰ç”µæ± ç”µå‹å€¼ã€‚

```c
void app_main(void)
{
    printf("hello yahboom\n");
    ESP_LOGI(TAG, "Nice to meet you!");

    Battery_Init();

    while (1)
    {
        vTaskDelay(pdMS_TO_TICKS(500));
        float voltage = Battery_Get_Voltage();
        ESP_LOGI(TAG, "Voltage:%.2fV", voltage);
    }
}
```

---

## å››ã€ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶

ä½¿ç”¨Type-Cæ•°æ®çº¿è¿æ¥è™šæ‹Ÿæœº/ç”µè„‘ä¸microROSæ§åˆ¶æ¿ï¼Œå¦‚æœç³»ç»Ÿå¼¹çª—é€‰æ‹©è¿æ¥åˆ°è™šæ‹Ÿæœºä¸Šã€‚

æ¿€æ´»ESP-IDFå¼€å‘ç¯å¢ƒï¼Œæ³¨æ„æ¯æ¬¡æ‰“å¼€æ–°ç»ˆç«¯éƒ½éœ€è¦å…ˆæ¿€æ´»ESP-IDFå¼€å‘ç¯å¢ƒæ‰å¯ä»¥ç¼–è¯‘å›ºä»¶ã€‚

```bash
source ~/esp/esp-idf/export.sh
```

è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd ~/esp/Samples/esp32_samples/voltage
```

ç¼–è¯‘ã€çƒ§å½•ã€æ‰“å¼€ä¸²å£æ¨¡æ‹Ÿå™¨

```bash
idf.py build flash monitor
```

å¦‚æœéœ€è¦é€€å‡ºä¸²å£æ¨¡æ‹Ÿå™¨ï¼Œè¯·æŒ‰**Ctrl+]**ã€‚

---

## äº”ã€å®éªŒæ•ˆæœ

ä¸²å£æ¨¡æ‹Ÿå™¨æ‰“å°"hello yahboom"æ¬¢è¿è¯ã€‚å¹¶ä¸”æŒç»­æ‰“å°å½“å‰ç”µæ± ç”µå‹å€¼ï¼Œä¾‹å¦‚å½“å‰ç”µæ± ç”µå‹ä¸º7.05Vã€‚

![image-20240111141215200](https://www.yahboom.com/public/upload/upload-html/1706346778/image-20240111141215200.png)

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [[ESP32å¼€å‘åŸºç¡€]] - ESP32åŸºç¡€æ•™ç¨‹
- [[3 Resources/01-Tech/MicroROSæœºå™¨äººæ§åˆ¶æ¿]] - äº§å“ä¸»é¡µ
