---
title: 多话题订阅和发布
status: active
priority: medium
tags: [esp32/examples, microros/publisher, microros/subscriber]
aliases: [多话题订阅和发布, microROS多话题]
created: 2026-02-19
modified: 2026-02-19
source: https://www.yahboom.com/public/upload/upload-html/1706347362/多话题订阅和发布.html
related:
  - [[MicroROS机器人控制板]]
  - [[发布话题]]
  - [[订阅话题]]
---

# 多话题订阅和发布

> 学习ESP32-microROS组件，同时发布和订阅多个ROS2话题。

---

## 目录

- [实验目的](#一实验目的)
- [硬件连接](#二硬件连接)
- [核心代码解析](#三核心代码解析)
- [编译下载烧录固件](#四编译下载烧录固件)
- [实验效果](#五实验效果)

---

## 一、实验目的

学习ESP32-microROS组件，同时发布和订阅多个ROS2话题。

---

## 二、硬件连接

如下图所示，microROS控制板集成了ESP32-S3-WROOM核心模组，自带无线WiFi功能，ESP32-S3核心模组需要连接天线，还需要把type-C数据线连接电脑与microROS控制板作为烧录固件功能。

![image-20240112174901940](https://www.yahboom.com/public/upload/upload-html/1706347362/image-20240112174901940.png)

---

## 三、核心代码解析

程序源码对应的虚拟机路径为：

```
~/esp/Samples/microros_samples/publisher_and_subscriber
```

本例程基于publisher和subscriber两个例程合并而来，实现了同时订阅和发布多个话题的功能。

### 同时订阅和发布配置

创建一个节点"esp32_subscriber_publisher"，一个发布者和一个订阅者。

```c
rcl_node_t node;
RCCHECK(rclc_node_init_default(&node, "esp32_subscriber_publisher", ROS_NAMESPACE, &support));

// 创建发布者
rcl_publisher_t publisher;
RCCHECK(rclc_publisher_init_default(
    &publisher,
    &node,
    ROSIDL_GET_MSG_TYPE_SUPPORT(std_msgs, msg, Int32),
    "publisher"));

// 创建订阅者
rcl_subscription_t subscriber;
RCCHECK(rclc_subscription_init_default(
    &subscriber,
    &node,
    ROSIDL_GET_MSG_TYPE_SUPPORT(std_msgs, msg, Int32),
    "subscriber"));
```

创建执行者，handle_num参数设置为2，表示要处理一个发布者定时器和一个订阅者。

```c
rclc_executor_t executor;
int handle_num = 2;
RCCHECK(rclc_executor_init(&executor, &support.context, handle_num, &allocator));
RCCHECK(rclc_executor_add_timer(&executor, &timer));
RCCHECK(rclc_executor_add_subscription(&executor, &subscriber, &recv_msg, &subscription_callback, ON_NEW_DATA));
```

在主循环中调用`rclc_executor_spin_some`让microROS正常工作。

```c
while (1)
{
   rclc_executor_spin_some(&executor, RCL_MS_TO_NS(100));
   usleep(1000);
}
```

---

## 四、编译下载烧录固件

使用Type-C数据线连接虚拟机/电脑与microROS控制板，如果系统弹窗选择连接到虚拟机上。

激活ESP-IDF开发环境，注意每次打开新终端都需要先激活ESP-IDF开发环境才可以编译固件。

```bash
source ~/esp/esp-idf/export.sh
```

进入项目目录：

```bash
cd ~/esp/Samples/microros_samples/publisher_and_subscriber
```

打开ESP-IDF的配置工具。

```bash
idf.py menuconfig
```

打开micro-ROS Settings，在micro-ROS Agent IP填入代理主机的IP地址，在micro-ROS Agent Port填入代理主机的端口号。

依次打开micro-ROS Settings->WiFi Configuration，在WiFi SSID和WiFi Password这两栏填入自家的WiFi名称和密码。

打开micro-ROS example-app settings，设置Ros domain id和Ros namespace。

修改后按S保存，再按Q退出配置工具。

编译、烧录、打开串口模拟器。

```bash
idf.py build flash monitor
```

如果需要退出串口模拟器，请按**Ctrl+]**。

---

## 五、实验效果

开机后，ESP32尝试连接WiFi热点，再尝试连接代理IP和端口。

启动micro-ROS代理：

```bash
docker run -it --rm -v /dev:/dev -v /dev/shm:/dev/shm --privileged --net=host microros/micro-ros-agent:humble udp4 --port 8090 -v4
```

连接成功后创建一个节点、一个发布者和一个订阅者。

查看节点信息：

```bash
ros2 node list
ros2 node info /esp32_subscriber_publisher
```

订阅/publisher话题查看发布的数据：

```bash
ros2 topic echo /publisher
```

向/subscriber话题发送数据：

```bash
ros2 topic pub /subscriber std_msgs/msg/Int32 "data: 123"
```

---

## 相关文档

- [[发布话题]] - 发布ROS2话题
- [[订阅话题]] - 订阅ROS2话题
- [[发布速度话题]] - 速度数据发布
