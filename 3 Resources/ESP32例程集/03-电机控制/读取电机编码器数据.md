---
title: è¯»å–ç”µæœºç¼–ç å™¨æ•°æ®
status: active
priority: medium
tags: [esp32/examples, encoder, motor]
aliases: [ç¼–ç å™¨è¯»å–, ç”µæœºç¼–ç å™¨]
created: 2026-02-19
modified: 2026-02-19
source: https://www.yahboom.com/public/upload/upload-html/1706346819/%E8%AF%BB%E5%8F%96%E7%94%B5%E6%9C%BA%E7%BC%96%E7%A0%81%E5%99%A8%E6%95%B0%E6%8D%AE.html
related:
  - [[MicroROSæœºå™¨äººæ§åˆ¶æ¿]]
  - [[é©±åŠ¨ç”µæœº]]
---

# è¯»å–ç”µæœºç¼–ç å™¨æ•°æ®

> ä½¿ç”¨microROSæ§åˆ¶æ¿çš„ç¼–ç ç”µæœºæ¥å£ï¼Œå­¦ä¹ ESP32å¦‚ä½•ä½¿ç”¨PCNTç»„ä»¶æ•è·ç”µæœºç¼–ç å™¨è„‰å†²æ•°é‡ã€‚

---

## ğŸ“‹ ç›®å½•

- [å®éªŒç›®çš„](#ä¸€å®éªŒç›®çš„)
- [ç¡¬ä»¶è¿æ¥](#äºŒç¡¬ä»¶è¿æ¥)
- [æ ¸å¿ƒä»£ç è§£æ](#ä¸‰æ ¸å¿ƒä»£ç è§£æ)
- [ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶](#å››ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶)
- [å®éªŒæ•ˆæœ](#äº”å®éªŒæ•ˆæœ)

---

## ä¸€ã€å®éªŒç›®çš„

ä½¿ç”¨microROSæ§åˆ¶æ¿çš„ç¼–ç ç”µæœºæ¥å£ï¼Œå­¦ä¹ ESP32å¦‚ä½•ä½¿ç”¨PCNTç»„ä»¶æ•è·ç”µæœºç¼–ç å™¨è„‰å†²æ•°é‡ã€‚

---

## äºŒã€ç¡¬ä»¶è¿æ¥

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒmicroROSæ§åˆ¶æ¿é›†æˆäº†å››è·¯ç¼–ç å™¨ç”µæœºæ§åˆ¶æ¥å£ï¼Œéœ€è¦é¢å¤–è¿æ¥ç¼–ç å™¨ç”µæœºï¼Œç”µæœºæ§åˆ¶æ¥å£æ”¯æŒ310ç”µæœºï¼Œè¿˜éœ€è¦æŠŠtype-Cæ•°æ®çº¿è¿æ¥ç”µè„‘ä¸microROSæ§åˆ¶æ¿ä½œä¸ºçƒ§å½•å›ºä»¶åŠŸèƒ½ã€‚

![image-20240111152814048](https://www.yahboom.com/public/upload/upload-html/1706346819/image-20240111152814048.png)

å››è·¯ç”µæœºæ¥å£åˆ†åˆ«å¯¹åº”åç§°ä¸º:å·¦å‰è½®->Motor1ï¼Œå·¦åè½®->Motor2ï¼Œå³å‰è½®->Motor3ï¼Œå³åè½®->Motor4ã€‚

![image-20240111155522592](https://www.yahboom.com/public/upload/upload-html/1706346819/image-20240111155522592.png)

ç”µæœºæ¥å£çº¿åºï¼Œåœ¨microROSæ§åˆ¶æ¿èƒŒé¢æœ‰è¯¦ç»†çº¿åºä¸å°ï¼Œè¿™é‡Œä»¥Motor1ä¸ºä¾‹ï¼ŒM1+å’ŒM1-æ˜¯æ§åˆ¶ç”µæœºè½¬åŠ¨çš„æ¥å£ï¼ŒGNDå’ŒVCCæ˜¯ç¼–ç å™¨çš„ä¾›ç”µç”µè·¯ï¼ŒH1Aå’ŒH1Bä¸ºç¼–ç å™¨è„‰å†²æ£€æµ‹å¼•è„šã€‚

![image-20240111160116671](https://www.yahboom.com/public/upload/upload-html/1706346819/image-20240111160116671.png)

> **æ³¨æ„**: å¦‚æœæ˜¯ä½¿ç”¨äºšåšæ™ºèƒ½é…å¥—çš„310ç”µæœºå’Œç”µæœºçº¿ï¼Œç™½è‰²çº¿å£³ç«¯è¿æ¥åˆ°microROSæ§åˆ¶æ¿ä¸Šçš„æ¥å£ï¼Œé»‘è‰²çº¿å£³ç«¯è¿æ¥åˆ°310ç”µæœºæ¥å£ã€‚

---

## ä¸‰ã€æ ¸å¿ƒä»£ç è§£æ

ç¨‹åºæºç å¯¹åº”çš„è™šæ‹Ÿæœºè·¯å¾„ä¸ºï¼š

```
~/esp/Samples/esp32_samples/encoder
```

### åˆå§‹åŒ–ç¼–ç å™¨

ç”±äºå››è·¯ç”µæœºçš„åˆå§‹åŒ–è¿‡ç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œä»¥åˆå§‹åŒ–ç”µæœº1çš„ç¼–ç å™¨ä¸ºä¾‹ã€‚

é¦–å…ˆåˆå§‹åŒ–ç”µæœº1çš„GPIO H1Aå’ŒH1Bä¸ºPCNTæ•è·æ¥å£ï¼Œé¢‘ç‡ä¸º25KHzï¼Œé€‰æ‹©å®šæ—¶å™¨ç»„0ä¸ºç”µæœºMotor1çš„PWMè¾“å‡ºå®šæ—¶å™¨ç»„ã€‚

```c
static void Encoder_M1_Init(void)
{
    pcnt_unit_config_t unit_config = {
        .high_limit = ENCODER_PCNT_HIGH_LIMIT,
        .low_limit = ENCODER_PCNT_LOW_LIMIT,
        .flags.accum_count = true, // enable counter accumulation
    };

    pcnt_unit_handle_t pcnt_unit = NULL;
    ESP_ERROR_CHECK(pcnt_new_unit(&unit_config, &pcnt_unit));

    pcnt_glitch_filter_config_t filter_config = {
        .max_glitch_ns = 1000,
    };
    ESP_ERROR_CHECK(pcnt_unit_set_glitch_filter(pcnt_unit, &filter_config));

    pcnt_chan_config_t chan_a_config = {
        .edge_gpio_num = ENCODER_GPIO_H1A,
        .level_gpio_num = ENCODER_GPIO_H1B,
    };

    pcnt_channel_handle_t pcnt_chan_a = NULL;
    ESP_ERROR_CHECK(pcnt_new_channel(pcnt_unit, &chan_a_config, &pcnt_chan_a));

    pcnt_chan_config_t chan_b_config = {
        .edge_gpio_num = ENCODER_GPIO_H1B,
        .level_gpio_num = ENCODER_GPIO_H1A,
    };

    pcnt_channel_handle_t pcnt_chan_b = NULL;
    ESP_ERROR_CHECK(pcnt_new_channel(pcnt_unit, &chan_b_config, &pcnt_chan_b));

    ESP_ERROR_CHECK(pcnt_channel_set_edge_action(pcnt_chan_a, PCNT_CHANNEL_EDGE_ACTION_DECREASE, PCNT_CHANNEL_EDGE_ACTION_INCREASE));
    ESP_ERROR_CHECK(pcnt_channel_set_level_action(pcnt_chan_a, PCNT_CHANNEL_LEVEL_ACTION_KEEP, PCNT_CHANNEL_LEVEL_ACTION_INVERSE));

    ESP_ERROR_CHECK(pcnt_channel_set_edge_action(pcnt_chan_b, PCNT_CHANNEL_EDGE_ACTION_INCREASE, PCNT_CHANNEL_EDGE_ACTION_DECREASE));
    ESP_ERROR_CHECK(pcnt_channel_set_level_action(pcnt_chan_b, PCNT_CHANNEL_LEVEL_ACTION_KEEP, PCNT_CHANNEL_LEVEL_ACTION_INVERSE));

    ESP_ERROR_CHECK(pcnt_unit_add_watch_point(pcnt_unit, ENCODER_PCNT_HIGH_LIMIT));
    ESP_ERROR_CHECK(pcnt_unit_add_watch_point(pcnt_unit, ENCODER_PCNT_LOW_LIMIT));

    ESP_ERROR_CHECK(pcnt_unit_enable(pcnt_unit));
    ESP_ERROR_CHECK(pcnt_unit_clear_count(pcnt_unit));
    ESP_ERROR_CHECK(pcnt_unit_start(pcnt_unit));

    encoder_unit_m1 = pcnt_unit;
}
```

### è¯»å–ç¼–ç å™¨æ•°æ®

è¯»å–ç”µæœº1ç´¯è®¡çš„ç¼–ç å™¨è„‰å†²æ•°é‡ã€‚

```c
int Encoder_Get_Count_M1(void)
{
    static int count_m1 = 0;
    pcnt_unit_get_count(encoder_unit_m1, &count_m1);
    return count_m1;
}
```

ä¸ºäº†è¯»å–æ–¹ä¾¿ï¼Œæ ¹æ®ç¼–ç å™¨çš„IDå·æ¥è·å–ç”µæœºç´¯è®¡çš„ç¼–ç å™¨è„‰å†²æ•°é‡ã€‚

```c
int Encoder_Get_Count(uint8_t encoder_id)
{
    if (encoder_id == ENCODER_ID_M1) return Encoder_Get_Count_M1();
    if (encoder_id == ENCODER_ID_M2) return Encoder_Get_Count_M2();
    if (encoder_id == ENCODER_ID_M3) return Encoder_Get_Count_M3();
    if (encoder_id == ENCODER_ID_M4) return Encoder_Get_Count_M4();
    return 0;
}
```

åœ¨app_mainé‡Œè°ƒç”¨Encoder_Initå‡½æ•°åˆå§‹åŒ–ç”µæœºç¼–ç å™¨ï¼Œåœ¨å¾ªç¯ä¸­æ¯é—´éš”200æ¯«ç§’æ‰“å°ä¸€æ¬¡å››ä¸ªç”µæœºç¼–ç å™¨ç´¯è®¡çš„è„‰å†²æ•°é‡ã€‚

```c
void app_main(void)
{
    printf("hello yahboom\n");
    ESP_LOGI(TAG, "Nice to meet you!");

    Encoder_Init();
    vTaskDelay(pdMS_TO_TICKS(1000));

    while (1)
    {
        ESP_LOGI(TAG, "Encoder:%d, %d, %d, %d",
            Encoder_Get_Count_M1(), Encoder_Get_Count_M2(),
            Encoder_Get_Count_M3(), Encoder_Get_Count_M4());
        vTaskDelay(pdMS_TO_TICKS(200));
    }
}
```

---

## å››ã€ç¼–è¯‘ä¸‹è½½çƒ§å½•å›ºä»¶

ä½¿ç”¨Type-Cæ•°æ®çº¿è¿æ¥è™šæ‹Ÿæœº/ç”µè„‘ä¸microROSæ§åˆ¶æ¿ï¼Œå¦‚æœç³»ç»Ÿå¼¹çª—é€‰æ‹©è¿æ¥åˆ°è™šæ‹Ÿæœºä¸Šã€‚

æ¿€æ´»ESP-IDFå¼€å‘ç¯å¢ƒï¼Œæ³¨æ„æ¯æ¬¡æ‰“å¼€æ–°ç»ˆç«¯éƒ½éœ€è¦å…ˆæ¿€æ´»ESP-IDFå¼€å‘ç¯å¢ƒæ‰å¯ä»¥ç¼–è¯‘å›ºä»¶ã€‚

```bash
source ~/esp/esp-idf/export.sh
```

è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd ~/esp/Samples/esp32_samples/encoder
```

ç¼–è¯‘ã€çƒ§å½•ã€æ‰“å¼€ä¸²å£æ¨¡æ‹Ÿå™¨

```bash
idf.py build flash monitor
```

å¦‚æœéœ€è¦é€€å‡ºä¸²å£æ¨¡æ‹Ÿå™¨ï¼Œè¯·æŒ‰**Ctrl+]**ã€‚

---

## äº”ã€å®éªŒæ•ˆæœ

ä¸²å£æ¨¡æ‹Ÿå™¨æ‰“å°"hello yahboom"æ¬¢è¿è¯ã€‚æ­¤æ—¶ä¼šæ¯é—´éš”200æ¯«ç§’æ‰“å°ä¸€æ¬¡å››è·¯ç”µæœºç¼–ç å™¨çš„è„‰å†²æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè½¬åŠ¨ç”µæœºMotor3ï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªæ•°æ®ä¼šæœ‰å˜åŒ–ã€‚

æ ¹æ®ç”µæœºçš„å‚æ•°ï¼Œå¾—åˆ°ç”µæœºå‡é€Ÿæ¯”ä¸º1:20ï¼Œç¼–ç å™¨ä¸º13çº¿ABç›¸éœå°”ç¼–ç å™¨ï¼Œè½¯ä»¶é‡‡ç”¨é«˜ä½ç”µå¹³åŒæ—¶è§¦å‘çš„æ–¹å¼ï¼Œæ‰€ä»¥ç†è®ºç”µæœºè½¬ä¸€åœˆçš„è„‰å†²æ•°é‡åº”ä¸º1040ã€‚

![image-20240111190401582](https://www.yahboom.com/public/upload/upload-html/1706346819/image-20240111190401582.png)

ä»¥è½¬åŠ¨ç”µæœº3ä¸ºä¾‹ï¼Œè½¦è½®å‘å‰è½¬æ—¶ï¼Œç¼–ç å™¨æ•°æ®ç´¯åŠ ï¼Œå½“è½¦è½®å‘å‰è½¬ä¸€åœˆï¼Œç¼–ç å™¨æ•°æ®å¤§çº¦å¢åŠ 1040ã€‚ç”±äºæ‰‹åŠ¨è½¬åŠ¨å­˜åœ¨ä¸€å®šè¯¯å·®ï¼Œæ‰€ä»¥æ•°å€¼å¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œåªè¦å·®è·ä¸å¤§å°±å¯ä»¥ã€‚

æŒ‰ä¸€ä¸‹microROSæ§åˆ¶æ¿çš„å¤ä½é”®ï¼Œé‡ç½®æ•°å€¼ä¸º0ã€‚è½¦è½®å‘åè½¬æ—¶ï¼Œç¼–ç å™¨æ•°æ®ç´¯å‡ï¼Œå¦‚æœå‘åè½¬ä¸€åœˆï¼Œåˆ™å¤§çº¦å‡å°‘1040ã€‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [[é©±åŠ¨ç”µæœº]] - ç”µæœºé©±åŠ¨å®éªŒ
- [[PIDæ§åˆ¶ç”µæœºé€Ÿåº¦]] - PIDé€Ÿåº¦æ§åˆ¶
