---
title: TCP协议深入
aliases:
  - Transmission Control Protocol
  - 三次握手
  - 四次挥手
para: resource
tags:
  - 核心协议
  - TCP
  - 传输层
  - 计算机网络
created: 2026-01-21
---

> [!summary] TCP协议概述
> TCP (Transmission Control Protocol) 是传输层协议，提供可靠的、面向连接的字节流传输服务。

---

## 🎯 TCP特点

| 特点 | 说明 |
|------|------|
| ✅ **面向连接** | 需要三次握手建立连接 |
| ✅ **可靠传输** | 确认应答、重传机制 |
| ✅ **有序传输** | 使用序列号保证顺序 |
| ✅ **流量控制** | 滑动窗口机制 |
| ✅ **拥塞控制** | 慢启动、拥塞避免 |
| ⚠️ **面向字节流** | 无消息边界 |

---

## 🔄 三次握手

### 过程图

```
客户端                           服务器
  │                               │
  │─── SYN=1, seq=x ─────────────→│ (SYN_SENT)
  │                               │
  │←── SYN=1, ACK=1, seq=y, ack=x+1 ──│ (SYN_RCVD)
  │                               │
  │─── ACK=1, seq=x+1, ack=y+1 ──→│ (ESTABLISHED)
  │                               │ (ESTABLISHED)
  │     连接建立成功                 │
```

### 详细步骤

1. **客户端发送SYN**：
   - SYN=1, seq=x（初始序列号）
   - 客户端进入 `SYN_SENT` 状态

2. **服务器回复SYN+ACK**：
   - SYN=1, ACK=1, seq=y, ack=x+1
   - 服务器进入 `SYN_RCVD` 状态

3. **客户端发送ACK**：
   - ACK=1, seq=x+1, ack=y+1
   - 双方都进入 `ESTABLISHED` 状态

### 为什么是三次？

- **一次握手**：无法确认双方都能收发
- **两次握手**：无法确认客户端的接收能力
- **三次握手**：确保双方收发能力都正常

---

## 👋 四次挥手

### 过程图

```
客户端                           服务器
  │ (ESTABLISHED)                │ (ESTABLISHED)
  │                               │
  │─── FIN=1, seq=u ────────────→│ (FIN_WAIT_1)
  │                               │
  │←── ACK=1, seq=v, ack=u+1 ─────│ (FIN_WAIT_2)
  │                               │ (CLOSE_WAIT)
  │                               │
  │←── FIN=1, seq=w, ack=u+1 ─────│ (LAST_ACK)
  │                               │
  │─── ACK=1, seq=u+1, ack=w+1 ──→│ (TIME_WAIT)
  │                               │ (CLOSED)
  │ 等待2MSL                       │
  │ (CLOSED)                      │
```

### 详细步骤

1. **客户端发送FIN**：
   - 客户端不再发送数据
   - 进入 `FIN_WAIT_1` 状态

2. **服务器回复ACK**：
   - 确认收到FIN
   - 客户端进入 `FIN_WAIT_2`
   - 服务器进入 `CLOSE_WAIT`

3. **服务器发送FIN**：
   - 服务器数据发送完毕
   - 进入 `LAST_ACK`

4. **客户端回复ACK**：
   - 进入 `TIME_WAIT`
   - 等待2MSL（Maximum Segment Lifetime）
   - 最终进入 `CLOSED`

### 为什么是四次？

- **三次不够**：服务器可能还有数据需要发送
- 需要分别确认双方的数据都已传输完毕

---

## 🎛️ 滑动窗口

### 概念

滑动窗口是TCP流量控制的核心机制，通过动态调整发送窗口大小来控制发送速率。

```
发送窗口
┌────┬────┬────┬────┬────┬────┬────┬────┐
│已发│已发│未发│未发│未发│未发│未发│未发│
│已确│未确│    │    │    │    │    │    │
└────┴────┴────┴────┴────┴────┴────┴────┘
    ↑    ↑         ↑
  SND.UNA SND.NXT  SND.UNA+WND
```

### 窗口字段

- **窗口大小**：接收缓冲区可用空间
- **接收窗口**：接收方告诉发送方还能发多少数据
- **发送窗口**：发送方实际可发送的数据量

---

## 🚦 拥塞控制

### 四个阶段

```
        拥塞窗口
            │
            │    ┌────────┐
            │   /│        │
            │  / │  慢启动│
            │ /  └────────┘
            │/
            │──────────────────────
            │                    \
            │                     \ ┌───────────┐
            │                      \| 拥塞避免  │
            │                       └───────────┘
            │
            │     ┌───────────┐
            │    /│           │
            │   / │  快重传   │
            │  /  └───────────┘
            │ /
            │/
            └─────────────────────────
              拥塞窗口
```

### 算法

#### 1. 慢启动
- 初始窗口：1 MSS
- 每次RTT窗口翻倍：cwnd *= 2
- 达到慢启动阈值（ssthresh）后进入拥塞避免

#### 2. 拥塞避免
- 每次RTT窗口增加1 MSS：cwnd += 1
- 线性增长

#### 3. 快重传
- 收到3个重复ACK
- 立即重传丢失的报文
- cwnd = ssthresh / 2
- ssthresh = cwnd / 2

#### 4. 快恢复
- 进入快恢复状态
- 不进入慢启动
- cwnd = ssthresh
- 收到新的ACK后，cwnd += 1 MSS

---

## 📊 TCP头部格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 字段说明

| 字段 | 大小 | 说明 |
|------|------|------|
| 源端口 | 16位 | 发送端口号 |
| 目的端口 | 16位 | 接收端口号 |
| 序列号 | 32位 | 数据字节序号 |
| 确认号 | 32位 | 期望收到的下一个字节序号 |
| 数据偏移 | 4位 | TCP头部长度 |
| URG | 1位 | 紧急指针有效 |
| ACK | 1位 | 确认号有效 |
| PSH | 1位 | 推送数据 |
| RST | 1位 | 重置连接 |
| SYN | 1位 | 同步序号 |
| FIN | 1位 | 结束连接 |
| 窗口 | 16位 | 接收窗口大小 |
| 校验和 | 16位 | 头部和数据的校验 |
| 紧急指针 | 16位 | 紧急数据的偏移量 |

---

## 🆚 TCP vs UDP

| 特性 | TCP | UDP |
|------|-----|-----|
| 连接 | 面向连接 | 无连接 |
| 可靠性 | 可靠 | 不可靠 |
| 顺序 | 有序 | 无序 |
| 流量控制 | 有 | 无 |
| 拥塞控制 | 有 | 无 |
| 速度 | 较慢 | 较快 |
| 开销 | 较大 | 较小 |
| 适用场景 | Web、邮件、文件传输 | 视频、游戏、DNS |

---

## 🛠️ 实践示例

### 使用tcpdump抓包

```bash
# 抓取TCP包
tcpdump -i eth0 tcp

# 抓取特定端口的TCP包
tcpdump -i eth0 tcp port 80

# 抓取并显示详细内容
tcpdump -i eth0 -vvv tcp

# 保存到文件
tcpdump -i eth0 -w tcp.pcap tcp
```

### 使用Wireshark分析

1. 安装Wireshark
2. 选择网卡开始捕获
3. 过滤器：`tcp`
4. 查看TCP流：右键 → 追踪TCP流

---

## 📝 学习检查清单

- [ ] 能画出TCP三次握手和四次挥手的流程图
- [ ] 理解三次握手为什么需要三次
- [ ] 理解滑动窗口的流量控制机制
- [ ] 了解TCP拥塞控制的四个阶段
- [ ] 知道TCP头部的主要字段
- [ ] 能区分TCP和UDP的应用场景

---

## 🔗 相关链接

- 🔙 [[02-核心协议|返回核心协议]]
- 📖 [[UDP协议]]
- 🛠️ [[抓包分析工具]]

---

最后更新：2026-01-21
